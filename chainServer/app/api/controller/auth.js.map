{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\auth.js"
    ],
    "names": [
        "Base",
        "require",
        "rp",
        "module",
        "exports",
        "ddAction",
        "name",
        "post",
        "address",
        "console",
        "log",
        "store",
        "phone",
        "dd",
        "model",
        "add",
        "success",
        "loginByWeixinAction",
        "fullUserInfo",
        "code",
        "userInfo",
        "JSON",
        "parse",
        "rawData",
        "currentTime",
        "parseInt",
        "Date",
        "getTime",
        "clientIp",
        "options",
        "method",
        "url",
        "qs",
        "grant_type",
        "js_code",
        "secret",
        "think",
        "config",
        "appid",
        "sessionData",
        "openid",
        "fail",
        "crypto",
        "sha1",
        "createHash",
        "update",
        "session_key",
        "digest",
        "signature",
        "WeixinSerivce",
        "service",
        "weixinUserInfo",
        "decryptUserInfoData",
        "encryptedData",
        "iv",
        "isEmpty",
        "userId",
        "where",
        "weixin_openid",
        "getField",
        "is_new",
        "buffer",
        "Buffer",
        "from",
        "nickName",
        "nickname",
        "toString",
        "username",
        "uuid",
        "password",
        "register_time",
        "register_ip",
        "last_login_time",
        "last_login_ip",
        "mobile",
        "avatar",
        "avatarUrl",
        "gender",
        "country",
        "province",
        "city",
        "user_id",
        "newbuffer",
        "id",
        "newUserInfo",
        "field",
        "find",
        "TokenSerivce",
        "sessionKey",
        "create",
        "token",
        "logoutAction"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\api\\controller\\auth.js",
    "sourcesContent": [
        "const Base = require('./base.js');\r\nconst rp = require('request-promise');\r\nmodule.exports = class extends Base {\r\n    async ddAction(){\r\n        // this.body = 'hello world!';\r\n        const name = this.post('name');\r\n        const address = this.post('address');\r\n        console.log('_______________name___address', name, address)\r\n        let store = {\r\n            name,\r\n            address,\r\n            phone: 12321\r\n        }\r\n        const dd = await this.model('store').add(store);\r\n        console.log('////ddd',dd)\r\n        return this.success();\r\n    }\r\n    async loginByWeixinAction() {\r\n        // const code = this.post('code');\r\n        const fullUserInfo = this.post('info');\r\n        const code =fullUserInfo.code;\r\n        const userInfo = JSON.parse(fullUserInfo.rawData);\r\n        console.log('userInfo')\r\n        console.log(code)\r\n        console.log(userInfo)\r\n        console.log('userInfo')\r\n        let currentTime = parseInt(new Date().getTime() / 1000);\r\n        const clientIp = ''; // 暂时不记录 ip test git\r\n        // 获取openid\r\n        const options = {\r\n            method: 'GET',\r\n            url: 'https://api.weixin.qq.com/sns/jscode2session',\r\n            qs: {\r\n                grant_type: 'authorization_code',\r\n                js_code: code,\r\n                secret: think.config('weixin.secret'),\r\n                appid: think.config('weixin.appid')\r\n            }\r\n        };\r\n        let sessionData = await rp(options);\r\n        sessionData = JSON.parse(sessionData);\r\n        if (!sessionData.openid) {\r\n            return this.fail('登录失败1');\r\n        }\r\n        // 验证用户信息完整性\r\n        const crypto = require('crypto');\r\n        const sha1 = crypto.createHash('sha1').update(fullUserInfo.rawData + sessionData.session_key).digest('hex');\r\n        if (fullUserInfo.signature !== sha1) {\r\n            return this.fail('登录失败2');\r\n        }\r\n        // 解释用户数据\r\n        const WeixinSerivce = this.service('weixin', 'api');\r\n        const weixinUserInfo = await WeixinSerivce.decryptUserInfoData(sessionData.session_key, fullUserInfo.encryptedData, fullUserInfo.iv);\r\n        if (think.isEmpty(weixinUserInfo)) {\r\n            return this.fail('登录失败3');\r\n        }\r\n        // 根据openid查找用户是否已经注册\r\n        let userId = await this.model('user').where({\r\n            weixin_openid: sessionData.openid\r\n        }).getField('id', true);\r\n        let is_new = 0;\r\n        if (think.isEmpty(userId)) {\r\n            // 注册\r\n            const buffer = Buffer.from(userInfo.nickName);\r\n            let nickname = buffer.toString('base64');\r\n            userId = await this.model('user').add({\r\n                username: '微信用户' + think.uuid(6),\r\n                password: sessionData.openid,\r\n                register_time: currentTime,\r\n                register_ip: clientIp,\r\n                last_login_time: currentTime,\r\n                last_login_ip: clientIp,\r\n                mobile: '',\r\n                weixin_openid: sessionData.openid,\r\n                avatar: userInfo.avatarUrl || '',\r\n                gender: userInfo.gender || 1, // 性别 0：未知、1：男、2：女\r\n                nickname: nickname,\r\n                country: userInfo.country,\r\n                province: userInfo.province,\r\n                city: userInfo.city\r\n            });\r\n            is_new = 1;\r\n        }\r\n        sessionData.user_id = userId;\r\n        // 查询用户信息\r\n        const newbuffer = Buffer.from(userInfo.nickName);\r\n        let nickname = newbuffer.toString('base64');\r\n        // 更新登录信息\r\n        await this.model('user').where({\r\n            id: userId\r\n        }).update({\r\n            last_login_time: currentTime,\r\n            last_login_ip: clientIp,\r\n            avatar: userInfo.avatarUrl,\r\n            nickname: nickname,\r\n            country: userInfo.country,\r\n            province: userInfo.province,\r\n            city: userInfo.city\r\n        });\r\n        const newUserInfo = await this.model('user').field('id,username,nickname,gender, avatar').where({\r\n            id: userId\r\n        }).find();\r\n        newUserInfo.nickname = Buffer.from(newUserInfo.nickname, 'base64').toString();\r\n        const TokenSerivce = this.service('token', 'api');\r\n        const sessionKey = await TokenSerivce.create(sessionData);\r\n        if (think.isEmpty(newUserInfo) || think.isEmpty(sessionKey)) {\r\n            return this.fail('登录失败4');\r\n        }\r\n        return this.success({\r\n            token: sessionKey,\r\n            userInfo: newUserInfo,\r\n            is_new: is_new\r\n        });\r\n    }\r\n    async logoutAction() {\r\n        return this.success();\r\n    }\r\n};"
    ]
}