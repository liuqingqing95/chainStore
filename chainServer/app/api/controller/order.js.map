{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\order.js"
    ],
    "names": [
        "Base",
        "require",
        "moment",
        "rp",
        "fs",
        "http",
        "module",
        "exports",
        "listAction",
        "userId",
        "getLoginUserId",
        "showType",
        "get",
        "page",
        "size",
        "status",
        "model",
        "getOrderStatus",
        "is_delete",
        "orderList",
        "field",
        "where",
        "user_id",
        "order_type",
        "order_status",
        "order",
        "countSelect",
        "newOrderList",
        "item",
        "data",
        "goodsList",
        "order_id",
        "id",
        "select",
        "goodsCount",
        "forEach",
        "v",
        "number",
        "add_time",
        "unix",
        "getOrderAddTime",
        "format",
        "order_status_text",
        "getOrderStatusText",
        "handleOption",
        "getOrderHandleOption",
        "push",
        "success",
        "countAction",
        "allCount",
        "count",
        "orderCountAction",
        "toPay",
        "toDelivery",
        "toReceive",
        "newStatus",
        "detailAction",
        "orderId",
        "orderInfo",
        "find",
        "currentTime",
        "parseInt",
        "Date",
        "getTime",
        "think",
        "isEmpty",
        "fail",
        "province_name",
        "province",
        "getField",
        "city_name",
        "city",
        "district_name",
        "district",
        "full_region",
        "postscript",
        "Buffer",
        "from",
        "toString",
        "orderGoods",
        "gitem",
        "confirm_time",
        "dealdone_time",
        "pay_time",
        "shipping_time",
        "confirm_remainTime",
        "final_pay_time",
        "updateInfo",
        "update",
        "textCode",
        "getOrderTextCode",
        "orderGoodsAction",
        "cartList",
        "checked",
        "is_fast",
        "cancelAction",
        "post",
        "cancel",
        "goodsInfo",
        "goods_id",
        "product_id",
        "increment",
        "succesInfo",
        "deleteAction",
        "delete",
        "orderDeleteById",
        "confirmAction",
        "confirm",
        "completeAction",
        "submitAction",
        "addressId",
        "freightPrice",
        "offlinePay",
        "buffer",
        "checkedAddress",
        "checkedGoodsList",
        "checkPrice",
        "checkStock",
        "product",
        "goods_number",
        "retail_price",
        "add_price",
        "goodsTotalPrice",
        "cartItem",
        "orderTotalPrice",
        "actualPrice",
        "print_info",
        "i",
        "Number",
        "goods_aka",
        "def",
        "sender_name",
        "Name",
        "sender_mobile",
        "Tel",
        "userInfo",
        "order_sn",
        "generateOrderNumber",
        "consignee",
        "name",
        "mobile",
        "province_id",
        "city_id",
        "district_id",
        "address",
        "freight_price",
        "goods_price",
        "order_price",
        "actual_price",
        "change_price",
        "offline_pay",
        "add",
        "orderGoodsData",
        "goodsItem",
        "goods_name",
        "list_pic_url",
        "goods_specifition_name_value",
        "goods_specifition_ids",
        "addMany",
        "clearBuyGoods",
        "updateAction",
        "updateAddress",
        "expressAction",
        "info",
        "expressInfo",
        "updateTime",
        "update_time",
        "com",
        "is_finish",
        "shipperCode",
        "shipper_code",
        "expressNo",
        "logistic_code",
        "lastExpressInfo",
        "getExpressInfo",
        "deliverystatus",
        "newUpdateTime",
        "getDeliverystatus",
        "issign",
        "traces",
        "list",
        "JSON",
        "stringify",
        "dataInfo",
        "express_status",
        "express",
        "appCode",
        "config",
        "options",
        "method",
        "url",
        "headers",
        "sessionData",
        "parse",
        "result"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\api\\controller\\order.js",
    "sourcesContent": [
        "const Base = require('./base.js');\r\nconst moment = require('moment');\r\nconst rp = require('request-promise');\r\nconst fs = require('fs');\r\nconst http = require(\"http\");\r\nmodule.exports = class extends Base {\r\n    /**\r\n     * 获取订单列表\r\n     * @return {Promise} []\r\n     */\r\n    async listAction() {\r\n\t\t// const userId = this.getLoginUserId();;\r\n\t\tconst userId = this.getLoginUserId();\r\n\t\tconst showType = this.get('showType');\r\n        const page = this.get('page');\r\n        const size = this.get('size');\r\n        let status = [];\r\n        status = await this.model('order').getOrderStatus(showType);\r\n        let is_delete = 0;\r\n        const orderList = await this.model('order').field('id,add_time,actual_price,freight_price,offline_pay').where({\r\n            user_id: userId,\r\n            is_delete: is_delete,\r\n            order_type: ['<', 7],\r\n            order_status: ['IN', status]\r\n        }).page(page, size).order('add_time DESC').countSelect();\r\n        const newOrderList = [];\r\n        for (const item of orderList.data) {\r\n            // 订单的商品\r\n            item.goodsList = await this.model('order_goods').field('id,list_pic_url,number').where({\r\n                user_id: userId,\r\n                order_id: item.id,\r\n                is_delete: 0\r\n            }).select();\r\n            item.goodsCount = 0;\r\n            item.goodsList.forEach(v => {\r\n                item.goodsCount += v.number;\r\n            });\r\n            item.add_time = moment.unix(await this.model('order').getOrderAddTime(item.id)).format('YYYY-MM-DD HH:mm:ss');\r\n            // item.dealdone_time = moment.unix(await this.model('order').getOrderAddTime(item.id)).format('YYYY-MM-DD HH:mm:ss');\r\n            // item.add_time =this.timestampToTime(await this.model('order').getOrderAddTime(item.id));\r\n            // 订单状态的处理\r\n            item.order_status_text = await this.model('order').getOrderStatusText(item.id);\r\n            // 可操作的选项\r\n            item.handleOption = await this.model('order').getOrderHandleOption(item.id);\r\n            newOrderList.push(item);\r\n        }\r\n        orderList.data = newOrderList;\r\n        return this.success(orderList);\r\n    }\r\n    // 获得订单数量\r\n    //\r\n    async countAction() {\r\n        const showType = this.get('showType');\r\n\t\tconst userId = this.getLoginUserId();;\r\n        let status = [];\r\n        status = await this.model('order').getOrderStatus(showType);\r\n        let is_delete = 0;\r\n        const allCount = await this.model('order').where({\r\n            user_id: userId,\r\n            is_delete: is_delete,\r\n            order_status: ['IN', status]\r\n        }).count('id');\r\n        return this.success({\r\n            allCount: allCount,\r\n        });\r\n    }\r\n    // 获得订单数量状态\r\n    //\r\n    async orderCountAction() {\r\n\t\t// const user_id = this.getLoginUserId();;\r\n\t\tconst user_id = this.getLoginUserId();\r\n        let toPay = await this.model('order').where({\r\n            user_id: user_id,\r\n            is_delete: 0,\r\n            order_type: ['<', 7],\r\n            order_status: ['IN', '101,801']\r\n        }).count('id');\r\n        let toDelivery = await this.model('order').where({\r\n            user_id: user_id,\r\n            is_delete: 0,\r\n            order_type: ['<', 7],\r\n            order_status: 300\r\n        }).count('id');\r\n        let toReceive = await this.model('order').where({\r\n            user_id: user_id,\r\n            order_type: ['<', 7],\r\n            is_delete: 0,\r\n            order_status: 301\r\n        }).count('id');\r\n        let newStatus = {\r\n            toPay: toPay,\r\n            toDelivery: toDelivery,\r\n            toReceive: toReceive,\r\n        }\r\n        return this.success(newStatus);\r\n    }\r\n    async detailAction() {\r\n        const orderId = this.get('orderId');\r\n\t\tconst userId = this.getLoginUserId();;\r\n        const orderInfo = await this.model('order').where({\r\n            user_id: userId,\r\n            id: orderId\r\n        }).find();\r\n        const currentTime = parseInt(new Date().getTime() / 1000);\r\n        if (think.isEmpty(orderInfo)) {\r\n            return this.fail('订单不存在');\r\n        }\r\n        orderInfo.province_name = await this.model('region').where({\r\n            id: orderInfo.province\r\n        }).getField('name', true);\r\n        orderInfo.city_name = await this.model('region').where({\r\n            id: orderInfo.city\r\n        }).getField('name', true);\r\n        orderInfo.district_name = await this.model('region').where({\r\n            id: orderInfo.district\r\n        }).getField('name', true);\r\n        orderInfo.full_region = orderInfo.province_name + orderInfo.city_name + orderInfo.district_name;\r\n        orderInfo.postscript = Buffer.from(orderInfo.postscript, 'base64').toString();\r\n        const orderGoods = await this.model('order_goods').where({\r\n            user_id: userId,\r\n            order_id: orderId,\r\n            is_delete: 0\r\n        }).select();\r\n        var goodsCount = 0;\r\n        for (const gitem of orderGoods) {\r\n            goodsCount += gitem.number;\r\n        }\r\n        // 订单状态的处理\r\n        orderInfo.order_status_text = await this.model('order').getOrderStatusText(orderId);\r\n        if (think.isEmpty(orderInfo.confirm_time)) {\r\n            orderInfo.confirm_time = 0;\r\n        } else orderInfo.confirm_time = moment.unix(orderInfo.confirm_time).format('YYYY-MM-DD HH:mm:ss');\r\n        if (think.isEmpty(orderInfo.dealdone_time)) {\r\n            orderInfo.dealdone_time = 0;\r\n        } else orderInfo.dealdone_time = moment.unix(orderInfo.dealdone_time).format('YYYY-MM-DD HH:mm:ss');\r\n        if (think.isEmpty(orderInfo.pay_time)) {\r\n            orderInfo.pay_time = 0;\r\n        } else orderInfo.pay_time = moment.unix(orderInfo.pay_time).format('YYYY-MM-DD HH:mm:ss');\r\n        if (think.isEmpty(orderInfo.shipping_time)) {\r\n            orderInfo.shipping_time = 0;\r\n        } else {\r\n            orderInfo.confirm_remainTime = orderInfo.shipping_time + 10 * 24 * 60 * 60;\r\n            orderInfo.shipping_time = moment.unix(orderInfo.shipping_time).format('YYYY-MM-DD HH:mm:ss');\r\n        }\r\n        // 订单支付倒计时\r\n        if (orderInfo.order_status === 101 || orderInfo.order_status === 801) {\r\n            // if (moment().subtract(60, 'minutes') < moment(orderInfo.add_time)) {\r\n            orderInfo.final_pay_time = orderInfo.add_time + 24 * 60 * 60; //支付倒计时2小时\r\n            if (orderInfo.final_pay_time < currentTime) {\r\n                //超过时间不支付，更新订单状态为取消\r\n                let updateInfo = {\r\n                    order_status: 102\r\n                };\r\n                await this.model('order').where({\r\n                    id: orderId\r\n                }).update(updateInfo);\r\n            }\r\n        }\r\n        orderInfo.add_time = moment.unix(orderInfo.add_time).format('YYYY-MM-DD HH:mm:ss');\r\n        orderInfo.order_status = '';\r\n        // 订单可操作的选择,删除，支付，收货，评论，退换货\r\n        const handleOption = await this.model('order').getOrderHandleOption(orderId);\r\n        const textCode = await this.model('order').getOrderTextCode(orderId);\r\n        return this.success({\r\n            orderInfo: orderInfo,\r\n            orderGoods: orderGoods,\r\n            handleOption: handleOption,\r\n            textCode: textCode,\r\n            goodsCount: goodsCount,\r\n        });\r\n    }\r\n    /**\r\n     * order 和 order-check 的goodslist\r\n     * @return {Promise} []\r\n     */\r\n    async orderGoodsAction() {\r\n\t\tconst userId = this.getLoginUserId();;\r\n        const orderId = this.get('orderId');\r\n        if (orderId > 0) {\r\n            const orderGoods = await this.model('order_goods').where({\r\n                user_id: userId,\r\n                order_id: orderId,\r\n                is_delete: 0\r\n            }).select();\r\n            var goodsCount = 0;\r\n            for (const gitem of orderGoods) {\r\n                goodsCount += gitem.number;\r\n            }\r\n            return this.success(orderGoods);\r\n        } else {\r\n            const cartList = await this.model('cart').where({\r\n                user_id: userId,\r\n                checked:1,\r\n                is_delete: 0,\r\n                is_fast: 0,\r\n            }).select();\r\n            return this.success(cartList);\r\n        }\r\n    }\r\n    /**\r\n     * 取消订单\r\n     * @return {Promise} []\r\n     */\r\n    async cancelAction() {\r\n        const orderId = this.post('orderId');\r\n\t\tconst userId = this.getLoginUserId();;\r\n        // 检测是否能够取消\r\n        const handleOption = await this.model('order').getOrderHandleOption(orderId);\r\n        // console.log('--------------' + handleOption.cancel);\r\n        if (!handleOption.cancel) {\r\n            return this.fail('订单不能取消');\r\n        }\r\n        // 设置订单已取消状态\r\n        let updateInfo = {\r\n            order_status: 102\r\n        };\r\n        let orderInfo = await this.model('order').field('order_type').where({\r\n            id: orderId,\r\n            user_id: userId\r\n        }).find();\r\n        //取消订单，还原库存\r\n        const goodsInfo = await this.model('order_goods').where({\r\n            order_id: orderId,\r\n            user_id: userId\r\n        }).select();\r\n        for (const item of goodsInfo) {\r\n            let goods_id = item.goods_id;\r\n            let product_id = item.product_id;\r\n            let number = item.number;\r\n            await this.model('goods').where({\r\n                id: goods_id\r\n            }).increment('goods_number', number);\r\n            await this.model('product').where({\r\n                id: product_id\r\n            }).increment('goods_number', number);\r\n        }\r\n        const succesInfo = await this.model('order').where({\r\n            id: orderId\r\n        }).update(updateInfo);\r\n        return this.success(succesInfo);\r\n    }\r\n    /**\r\n     * 删除订单\r\n     * @return {Promise} []\r\n     */\r\n    async deleteAction() {\r\n        const orderId = this.post('orderId');\r\n        // 检测是否能够取消\r\n        const handleOption = await this.model('order').getOrderHandleOption(orderId);\r\n        if (!handleOption.delete) {\r\n            return this.fail('订单不能删除');\r\n        }\r\n        const succesInfo = await this.model('order').orderDeleteById(orderId);\r\n        return this.success(succesInfo);\r\n    }\r\n    /**\r\n     * 确认订单\r\n     * @return {Promise} []\r\n     */\r\n    async confirmAction() {\r\n        const orderId = this.post('orderId');\r\n        // 检测是否能够取消\r\n        const handleOption = await this.model('order').getOrderHandleOption(orderId);\r\n        if (!handleOption.confirm) {\r\n            return this.fail('订单不能确认');\r\n        }\r\n        // 设置订单已取消状态\r\n        const currentTime = parseInt(new Date().getTime() / 1000);\r\n        let updateInfo = {\r\n            order_status: 401,\r\n            confirm_time: currentTime\r\n        };\r\n        const succesInfo = await this.model('order').where({\r\n            id: orderId\r\n        }).update(updateInfo);\r\n        return this.success(succesInfo);\r\n    }\r\n    /**\r\n     * 完成评论后的订单\r\n     * @return {Promise} []\r\n     */\r\n    async completeAction() {\r\n        const orderId = this.get('orderId');\r\n        // 设置订单已完成\r\n        const currentTime = parseInt(new Date().getTime() / 1000);\r\n        let updateInfo = {\r\n            order_status: 401,\r\n            dealdone_time: currentTime\r\n        };\r\n        const succesInfo = await this.model('order').where({\r\n            id: orderId\r\n        }).update(updateInfo);\r\n        return this.success(succesInfo);\r\n    }\r\n    /**\r\n     * 提交订单\r\n     * @returns {Promise.<void>}\r\n     */\r\n    async submitAction() {\r\n        // 获取收货地址信息和计算运费\r\n\t\tconst userId = this.getLoginUserId();;\r\n        const addressId = this.post('addressId');\r\n        const freightPrice = this.post('freightPrice');\r\n        const offlinePay = this.post('offlinePay');\r\n        let postscript = this.post('postscript');\r\n        const buffer = Buffer.from(postscript); // 留言\r\n        const checkedAddress = await this.model('address').where({\r\n            id: addressId\r\n        }).find();\r\n        if (think.isEmpty(checkedAddress)) {\r\n            return this.fail('请选择收货地址');\r\n        }\r\n        // 获取要购买的商品\r\n        const checkedGoodsList = await this.model('cart').where({\r\n            user_id: userId,\r\n            checked: 1,\r\n            is_delete: 0\r\n        }).select();\r\n        if (think.isEmpty(checkedGoodsList)) {\r\n            return this.fail('请选择商品');\r\n        }\r\n        let checkPrice = 0;\r\n        let checkStock = 0;\r\n        for(const item of checkedGoodsList){\r\n            let product = await this.model('product').where({\r\n                id:item.product_id\r\n            }).find();\r\n            if(item.number > product.goods_number){\r\n                checkStock++;\r\n            }\r\n            if(item.retail_price != item.add_price){\r\n                checkPrice++;\r\n            }\r\n        }\r\n        if(checkStock > 0){\r\n            return this.fail(400, '库存不足，请重新下单');\r\n        }\r\n        if(checkPrice > 0){\r\n            return this.fail(400, '价格发生变化，请重新下单');\r\n        }\r\n        // 获取订单使用的红包\r\n        // 如果有用红包，则将红包的数量减少，当减到0时，将该条红包删除\r\n        // 统计商品总价\r\n        let goodsTotalPrice = 0.00;\r\n        for (const cartItem of checkedGoodsList) {\r\n            goodsTotalPrice += cartItem.number * cartItem.retail_price;\r\n        }\r\n        // 订单价格计算\r\n        const orderTotalPrice = goodsTotalPrice + freightPrice; // 订单的总价\r\n        const actualPrice = orderTotalPrice - 0.00; // 减去其它支付的金额后，要实际支付的金额 比如满减等优惠\r\n        const currentTime = parseInt(new Date().getTime() / 1000);\r\n        let print_info = '';\r\n        for (const item in checkedGoodsList) {\r\n            let i = Number(item) + 1;\r\n            print_info = print_info + i + '、' + checkedGoodsList[item].goods_aka + '【' + checkedGoodsList[item].number + '】 ';\r\n        }\r\n        let def = await this.model('settings').where({\r\n            id: 1\r\n        }).find();\r\n        let sender_name = def.Name;\r\n        let sender_mobile = def.Tel;\r\n        // let sender_address = '';\r\n        let userInfo = await this.model('user').where({\r\n            id: userId\r\n        }).find();\r\n        // const checkedAddress = await this.model('address').where({id: addressId}).find();\r\n        const orderInfo = {\r\n            order_sn: this.model('order').generateOrderNumber(),\r\n            user_id: userId,\r\n            // 收货地址和运费\r\n            consignee: checkedAddress.name,\r\n            mobile: checkedAddress.mobile,\r\n            province: checkedAddress.province_id,\r\n            city: checkedAddress.city_id,\r\n            district: checkedAddress.district_id,\r\n            address: checkedAddress.address,\r\n            order_status: 101, // 订单初始状态为 101\r\n            // 根据城市得到运费，这里需要建立表：所在城市的具体运费\r\n            freight_price: freightPrice,\r\n            postscript: buffer.toString('base64'),\r\n            add_time: currentTime,\r\n            goods_price: goodsTotalPrice,\r\n            order_price: orderTotalPrice,\r\n            actual_price: actualPrice,\r\n            change_price: actualPrice,\r\n            print_info: print_info,\r\n            offline_pay:offlinePay\r\n        };\r\n        // 开启事务，插入订单信息和订单商品\r\n        const orderId = await this.model('order').add(orderInfo);\r\n        orderInfo.id = orderId;\r\n        if (!orderId) {\r\n            return this.fail('订单提交失败');\r\n        }\r\n        // 将商品信息录入数据库\r\n        const orderGoodsData = [];\r\n        for (const goodsItem of checkedGoodsList) {\r\n            orderGoodsData.push({\r\n                user_id: userId,\r\n                order_id: orderId,\r\n                goods_id: goodsItem.goods_id,\r\n                product_id: goodsItem.product_id,\r\n                goods_name: goodsItem.goods_name,\r\n                goods_aka: goodsItem.goods_aka,\r\n                list_pic_url: goodsItem.list_pic_url,\r\n                retail_price: goodsItem.retail_price,\r\n                number: goodsItem.number,\r\n                goods_specifition_name_value: goodsItem.goods_specifition_name_value,\r\n                goods_specifition_ids: goodsItem.goods_specifition_ids\r\n            });\r\n        }\r\n        await this.model('order_goods').addMany(orderGoodsData);\r\n        await this.model('cart').clearBuyGoods();\r\n        return this.success({\r\n            orderInfo: orderInfo\r\n        });\r\n    }\r\n    async updateAction() {\r\n        const addressId = this.post('addressId');\r\n        const orderId = this.post('orderId');\r\n        // 备注\r\n        // let postscript = this.post('postscript');\r\n        // const buffer = Buffer.from(postscript);\r\n        const updateAddress = await this.model('address').where({\r\n            id: addressId\r\n        }).find();\r\n        const currentTime = parseInt(new Date().getTime() / 1000);\r\n        const orderInfo = {\r\n            // 收货地址和运费\r\n            consignee: updateAddress.name,\r\n            mobile: updateAddress.mobile,\r\n            province: updateAddress.province_id,\r\n            city: updateAddress.city_id,\r\n            district: updateAddress.district_id,\r\n            address: updateAddress.address,\r\n            // TODO 根据地址计算运费\r\n            // freight_price: 0.00,\r\n            // 备注\r\n            // postscript: buffer.toString('base64'),\r\n            // add_time: currentTime\r\n        };\r\n        const updateInfo = await this.model('order').where({\r\n            id: orderId\r\n        }).update(orderInfo);\r\n        return this.success(updateInfo);\r\n    }\r\n    /**\r\n     * 查询物流信息asd\r\n     * @returns {Promise.<void>}\r\n     */\r\n    async expressAction() {\r\n        const currentTime = parseInt(new Date().getTime() / 1000);\r\n        const orderId = this.get('orderId');\r\n        let info = await this.model('order_express').where({\r\n            order_id: orderId\r\n        }).find();\r\n        if (think.isEmpty(info)) {\r\n            return this.fail(400, '暂无物流信息');\r\n        }\r\n        const expressInfo = await this.model('order_express').where({\r\n            order_id: orderId\r\n        }).find();\r\n        // 如果is_finish == 1；或者 updateTime 小于 1分钟，\r\n        let updateTime = info.update_time;\r\n        let com = (currentTime - updateTime) / 60;\r\n        let is_finish = info.is_finish;\r\n        if (is_finish == 1) {\r\n            return this.success(expressInfo);\r\n        } else if (updateTime != 0 && com < 20) {\r\n            return this.success(expressInfo);\r\n        } else {\r\n            let shipperCode = expressInfo.shipper_code;\r\n            let expressNo = expressInfo.logistic_code;\r\n            let lastExpressInfo = await this.getExpressInfo(shipperCode, expressNo);\r\n            let deliverystatus = lastExpressInfo.deliverystatus;\r\n            let newUpdateTime = lastExpressInfo.updateTime;\r\n            newUpdateTime = parseInt(new Date(newUpdateTime).getTime() / 1000);\r\n            deliverystatus = await this.getDeliverystatus(deliverystatus);\r\n            let issign = lastExpressInfo.issign;\r\n            let traces = lastExpressInfo.list;\r\n            traces = JSON.stringify(traces);\r\n            let dataInfo = {\r\n                express_status: deliverystatus,\r\n                is_finish: issign,\r\n                traces: traces,\r\n                update_time: newUpdateTime\r\n            }\r\n            await this.model('order_express').where({\r\n                order_id: orderId\r\n            }).update(dataInfo);\r\n            let express = await this.model('order_express').where({\r\n                order_id: orderId\r\n            }).find();\r\n            return this.success(express);\r\n        }\r\n        // return this.success(latestExpressInfo);\r\n    }\r\n    async getExpressInfo(shipperCode, expressNo) {\r\n\t\tlet appCode = \"APPCODE \"+ think.config('aliexpress.appcode');\r\n        const options = {\r\n            method: 'GET',\r\n            url: 'http://wuliu.market.alicloudapi.com/kdi?no=' + expressNo + '&type=' + shipperCode,\r\n            headers: {\r\n                \"Content-Type\": \"application/json; charset=utf-8\",\r\n                \"Authorization\": appCode\r\n            }\r\n        };\r\n        let sessionData = await rp(options);\r\n        sessionData = JSON.parse(sessionData);\r\n        return sessionData.result;\r\n    }\r\n    async getDeliverystatus(status) {\r\n        if (status == 0) {\r\n            return '快递收件(揽件)';\r\n        } else if (status == 1) {\r\n            return '在途中';\r\n        } else if (status == 2) {\r\n            return '正在派件';\r\n        } else if (status == 3) {\r\n            return '已签收';\r\n        } else if (status == 4) {\r\n            return '派送失败(无法联系到收件人或客户要求择日派送，地址不详或手机号不清)';\r\n        } else if (status == 5) {\r\n            return '疑难件(收件人拒绝签收，地址有误或不能送达派送区域，收费等原因无法正常派送)';\r\n        } else if (status == 6) {\r\n            return '退件签收';\r\n        }\r\n    }\r\n};"
    ]
}